# Эвристический Анализ Скрытого ПО. Техники Инъекций и Методы Сокрытия, Приминение Дерева Решений

В мире инфобеза каждый день появляются новые угрозы, которые требующие постоянного улучшения и разработки новых методов обнаружения и борьбы с ними. Одним из важных аспектов в этом контексте является **анализ скрытого ПО**. В этой статье будет рассмотрен **эвристический метод** анализа, который является неотъемлемой частью защиты, особенно при рассмотрении техник инъекций, таких как SQL, XSS и Command, а также методов сокрытия: полиморфизм, метаморфизм и руткит.

## Техники Инъекций

### SQL Инъекции

SQL-инъекции - очень серьезная угроза для веб-приложений. Злоумышленники могут внедрить вредоносный SQL-код, тем самым получить доступ к БД. Применение эвристического анализа позволяет выявлять подозрительные запросы и блокировать потенциальные атаки.

#### Пример небезопасного кода на стороне сервера (в PHP) может выглядеть так

```php
<?php
$username = $_POST['username'];
$password = $_POST['password'];

$sql = "SELECT * FROM users WHERE username='$username' AND password='$password'";
$result = mysqli_query($conn, $sql);

// Обработка запроса...
?>
```

Если пользователь вводит в поле "username" следующее значение:

```sql
SELECT * FROM users WHERE username='admin' OR '1'='1'; --' AND password='...'
```

В результате этого запроса условие 1='1' всегда верно, и аутентификация проходит успешно для пользователя с именем admin, без проверки пароля. Знак "--" используется для комментирования оставшейся части запроса, чтобы избежать ошибок выполнения.

#### Рекомендации для предотвращения SQL-инъекций

* Параметризованные запросы (Prepared Statements):

Вместо встраивания пользовательского ввода непосредственно в SQL-запросы, следует использовать параметризованные запросы.

```php
$stmt = $conn->prepare("SELECT * FROM users WHERE username=? AND password=?");
$stmt->bind_param("ss", $username, $password);

$username = $_POST['username'];
$password = $_POST['password'];

$stmt->execute();
//  Обработка результата запроса...
$stmt->close();
```

* Фильтрация ввода:

Проверяйте входные данные на предмет корректности и фильтруйте их.

```php
$username = mysqli_real_escape_string($conn, $_POST['username']);
$password = mysqli_real_escape_string($conn, $_POST['password']);

$sql = "SELECT * FROM users WHERE username='$username' AND password='$password'";
// ...
```

### XSS Инъекции

XSS-инъекции могут привести к выполнению вредоносного кода в браузере пользователя.

Существует 2 вида XSS-инъекций:

* Хранилище (Stored XSS):

 ```html
 <!-- Злоумышленник внедряет вредоносный код в поле комментария -->
<div class="comment">Новый комментарий: <script>вредоносный код</script></div>
```

* Отраженный (Reflected XSS):

 ```html
 <!-- Злоумышленник внедряет вредоносный код в параметр URL -->
<a href="/search?q=<script>вредоносный код</script>">Поиск</a>
```

#### Способы защиты от XSS

* Экранирование данных:

Используйте функции экранирования, такие как htmlspecialchars, перед выводом данных на веб-страницу. Это предотвращает интерпретацию специальных символов как HTML или JavaScript кода.

```php
<?php
$user_input = "<script>alert('Вредоносный код');</script>";
echo htmlspecialchars($user_input, ENT_QUOTES, 'UTF-8');
?>
```

* Content Security Policy (CSP):

Внедрите политику безопасности контента (CSP), которая ограничит источники выполнения JavaScript-кода на веб-странице.

```html
<meta http-equiv="Content-Security-Policy" content="script-src 'self';">
```

* Валидация и фильтрация входных данных:

Проводите валидацию и фильтрацию входных данных на сервере. Отбрасывайте или корректируйте данные, не соответствующие ожидаемому формату.

```php
<?php
$user_input = $_POST['input'];
$filtered_input = filter_var($user_input, FILTER_SANITIZE_STRING);
?>
```

* HTTP Only Cookies:

Установите флаг HTTP Only для куки, чтобы ограничить доступ JavaScript к ним и предотвратить кражу сессий.

```html
Set-Cookie: sessionid=123; HttpOnly
```

### Командные Инъекции

Атаки, связанные с инъекциями команд, которые позволяют злоумышленникам выполнение вредоносных команд на сервере.

#### Примеры командных инъекций

* Команда в строке запроса (OS Command Injection)

```bash
# Внедрение вредоносную команду в URL
http://example.com/search?query=; rm -rf /
```

* Команда в форме (OS Command Injection)

```php
$user_input = $_POST['input'];
$command = "ping " . $user_input;
system($command);
```

#### Способы защиты от командных инъекций

* Параметризованные запросы:

Используйте параметризованные запросы в базе данных, чтобы предотвратить конкатенацию вредоносных данных с командами.

```php
<?php
$user_input = $_POST['input'];
$stmt = $pdo->prepare("SELECT * FROM users WHERE username = :username");
$stmt->bindParam(':username', $user_input);
$stmt->execute();
?>
```

* Экранирование данных:

Экранируйте или фильтруйте входные данные, чтобы предотвратить внедрение специальных символов.

```php
<?php
$user_input = $_POST['input'];
$filtered_input = escapeshellarg($user_input);
system("ping " . $filtered_input);
?>
```

* Белый список (Whitelisting):

Разрешайте только определенные команды или значения, используя белые списки.

```php
<?php
$allowed_commands = ['ping', 'ls', 'cat'];
$user_input = $_POST['input'];
if (in_array($user_input, $allowed_commands)) {
    system($user_input);
}
?>
```

## Методы Сокрытия

_Методы сокрытия обеспечивают ограничение доступа к внутренней реализации объекта и предоставление доступа к нему только через определенные интерфейсы. Основная идея заключается в том, чтобы скрыть детали реализации объекта от внешнего мира и предоставить только необходимый функционал через явно определенные методы._

### Полиморфизм

Полиморфизм в вредоносном ПО представляет собой стратегию: при которой происходит изменение формы и структуры кода таким образом, чтобы усложнить его обнаружение сигнатурными методами антивирусных программ. Например, вирус может использовать различные методы шифрования или изменять свою структуру с каждой новой инфекцией, что затрудняет определение уникальных сигнатур.

#### Пример

```php
// Обычная сигнатура
$signature = "malicious_function()";

// Полиморфный вирус изменяет сигнатуру
$signature = encrypt_signature($signature);
```

### Метаморфизм

Метаморфическое ПО изменяет свою структуру, сохраняя свою функциональность. Этот метод обеспечивает постоянное изменение внутреннего кода, что усложняет обнаружение и анализ вредоносной активности. Метаморфические вирусы могут переписывать себя так, чтобы сохранять свою функциональность, но иметь разную структуру.

### Руткиты

Руткиты представляют собой специальные инструменты, цель которых -  скрытие следов вредоносной активности в системе. Эти программы могут изменять системные вызовы, маскировать свою присутствие и подобное. Эвристический метод анализа может выявить подозрительные изменения в системных вызовах, которые могут оказаться признаком наличия руткита.

## Применение Дерева Решений в анализе скрытого ПО

Дерево решений выступает важным инструментом в области эвристического метода для анализа скрытого ПО. Это структурированное представление позволяет реализовать автоматизацию процесса принятия решений при обнаружении потенциального вредоносного ПО, основываясь на его характеристиках.

### Принцип работы дерева решений в анализе скрытого ПО

* Определение характеристик:

Определение ключевых характеристик скрытого ПО, таких как изменения в системных вызовах, необычные шаблоны кода, или странные сетевые активности.

* Формирование обучающего набора:

Создание обучающего набора, включающего в себя примеры как вредоносного, так и нормального ПО. Каждый образец ассоциируется с определенными характеристиками.

* Построение дерева:

Алгоритм дерева решений строит свою структуру, разветвляя узлы на основе информативных характеристик.

* Обучение и тестирование:

Дерево обучается на обучающем наборе, выявляя какие-то правила поиска. Затем оно тестируется, чтобы оценить эффективность на новых данных.

* Применение в реальном времени:

Готовое дерево решений интегрируют в систему анализа скрытого ПО для автоматического обнаружения и классификации потенциального вредоносного ПО.

### Преимущества использования дерева решений в анализе скрытого ПО

* Интерпретируемость:

Деревья решений легко понимаются человеком, что облегчает понимание логики принятия решений и выявление того, какие характеристики считаются наиболее важными.

* Эффективность:

Деревья решений способны обрабатывать большие объемы данных и эффективно классифицировать образцы, что особенно важно в контексте анализа скрытого ПО.

* Адаптивность:

Деревья решений могут быть легко обновлены с добавлением новых характеристик, что делает их адаптивными к изменяющейся природе угроз.

В заключение стоит отметить, что эвристический анализ является одним из ключевых элементов в обеспечении безопасности информационных систем. При использовании современных методов анализа скрытого ПО, таких как дерево решений, можно очень сильно повысить эффективность обнаружения и борьбы с таким видом ПО.
